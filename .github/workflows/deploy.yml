name: Deploy Angular to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Connect & Deploy to VPS
        id: deploy_step
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸ“¥ Entrando al directorio del proyecto"
            cd ${{ secrets.SERVER_PATH }}

            echo "â¬‡ Actualizando cÃ³digo"
            git pull origin main

            echo "ğŸ”¥ Construyendo e instalando sin downtime"
            docker compose up -d --build --remove-orphans

            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas"
            docker system prune -af || true

            echo "âœ” Deploy finalizado sin caÃ­da del servicio!"

      - name: Notificar Ã©xito por Telegram
        if: success()
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"ğŸš€ *DEPLOY COMPLETADO* âœ”\n\nğŸ“Œ Proyecto: gestify-solution-client\nğŸ§‘â€ğŸ’» Autor: ${{ github.actor }}\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ”¢ SHA: ${{ github.sha }}\nğŸ“… Fecha: ${{ github.event.head_commit.timestamp }}\nğŸ”— https://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }" \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage

      - name: Notificar error por Telegram
        if: failure()
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âŒ *DEPLOY FALLÃ“* â—\n\nğŸ§‘â€ğŸ’» Autor: ${{ github.actor }}\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ”¢ SHA: ${{ github.sha }}\nğŸ“… Fecha: ${{ github.event.head_commit.timestamp }}\nâš  Error: El proceso de deploy fallÃ³ en el servidor.\nğŸ”— RevisiÃ³n: https://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }" \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage

      - name: Enviar correo de Ã©xito
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âœ” Deploy completado en VPS"
          to: ${{ secrets.MAIL_TO }}
          from: "Deploy Bot <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ğŸš€ DEPLOY COMPLETADO CORRECTAMENTE

            Proyecto: gestify-solution-client
            Autor: ${{ github.actor }}
            Commit: ${{ github.event.head_commit.message }}
            SHA: ${{ github.sha }}
            Fecha: ${{ github.event.head_commit.timestamp }}
            RevisiÃ³n: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
      
      - name: Enviar correo de error
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ Deploy FALLÃ“ en VPS"
          to: ${{ secrets.MAIL_TO }}
          from: "Deploy Bot <${{ secrets.MAIL_USERNAME }}>"
          body: |
            âŒ ERROR EN EL DEPLOY

            Autor: ${{ github.actor }}
            Commit: ${{ github.event.head_commit.message }}
            SHA: ${{ github.sha }}
            Fecha: ${{ github.event.head_commit.timestamp }}
            
            RevisiÃ³n: https://github.com/${{ github.repository }}/commit/${{ github.sha }}

            âš  Revisa la ejecuciÃ³n fallida:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}