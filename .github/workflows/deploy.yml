name: Deploy Angular to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Connect & Deploy to VPS
        id: deploy_step
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "ğŸ“¥ Entrando al directorio del proyecto"
            cd ${{ secrets.SERVER_PATH }}

            echo "â¬‡ Actualizando cÃ³digo"
            git pull origin main

            echo "ğŸ›‘ Deteniendo contenedores anteriores (si existen)"
            docker compose down || true

            echo "ğŸ§¹ Eliminando contenedores huÃ©rfanos"
            docker compose rm -f || true

            echo "ğŸ”¥ Construyendo nueva imagen Docker"
            docker compose build --no-cache

            echo "ğŸš€ Levantando aplicaciÃ³n"
            docker compose up -d --remove-orphans

            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas, cache y volÃºmenes no usados"
            docker system prune -af --volumes || true

            echo "âœ” Deploy finalizado correctamente!"

      - name: Notificar Ã©xito por Telegram
        if: success()
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"ğŸš€ *DEPLOY COMPLETADO* âœ”\n\nğŸ“Œ Proyecto: gestify-solution-client\nğŸ§‘â€ğŸ’» Autor: ${{ github.actor }}\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ”¢ SHA: ${{ github.sha }}\nğŸ“… Fecha: ${{ github.event.head_commit.timestamp }}\nğŸ”— https://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }" \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage

      - name: Notificar error por Telegram
        if: failure()
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"âŒ *DEPLOY FALLÃ“* â—\n\nğŸ§‘â€ğŸ’» Autor: ${{ github.actor }}\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ”¢ SHA: ${{ github.sha }}\nğŸ“… Fecha: ${{ github.event.head_commit.timestamp }}\nâš  Error: El proceso de deploy fallÃ³ en el servidor.\nğŸ”— RevisiÃ³n: https://github.com/${{ github.repository }}/commit/${{ github.sha }}\"
            }" \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage
